<!DOCTYPE html>
<html>
    <head>
        <title>Button.test.html</title>
        <link rel="stylesheet" href="http://cdn.sencha.io/touch/sencha-touch-2.0.1/resources/css/sencha-touch.css" type="text/css">
        <link rel="stylesheet" href="../../resources/css/gxm.css" type="text/css">
        
        <script type="text/javascript" src="http://cdn.sencha.io/touch/sencha-touch-2.0.1/sencha-touch-all-debug.js"></script>
        <script type="text/javascript" src="http://openlayers.org/api/2.11/OpenLayers.js"></script>
        
        <!-- 
            Instead of using the Ext.loader-mechanism, we use a very simple 
            script-loader, which also works in e.g. the iPad and on iOs-Phones.
        -->
        <script type="text/javascript">
        window.LOAD_GXM = [
            "../../src/GXM/version.js",
            "../../src/GXM/util/Base.js",
            "../../src/GXM/Button.js",
            "../../src/GXM/data/LayerModel.js",
            "../../src/GXM/data/LayerStore.js",
            "../../src/GXM/Map.js"
        ];
        </script>
        <script type="text/javascript" src="../gxm.scriptloader.js"></script>
        
        <!-- load test helper functions -->
        <script type="text/javascript" src="../helperfunctions.js"></script>
        
        <script type="text/javascript">

var recordedEventData = {
    test_activateControlCalled: { 
        checkpoints: [], 
        events: [
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"mousedown", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null,
                screenY:"297", time:"1600"
            },
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"mouseup", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"1400"
            },
            {   
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"click", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"1200"
            },
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"mousedown", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"1000"
            },
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"mouseup", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"800"
            },
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"click", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"600"
            },
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"mousedown", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"400"
            },
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"mouseup", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"200"
            },
            {
                layerX:"6", y:"10", returnValue:"true", clientX:"924", 
                which:"1", shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"3040", x:"924", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"3", clientY:"10", 
                ctrlKey:"false", target:"#navigation-btn DIV", layerY:"3", 
                charCode:"0", type:"click", pageX:"924", 
                cancelBubble:"false", pageY:"10", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"6", relatedTarget:null, 
                screenY:"297", time:"0"
            }
        ]
    }, // eof test_activateControlCalled
    test_triggerControlCalled: { 
        checkpoints: [], 
        events: [
            {
                layerX:"9", y:"11", returnValue:"true", clientX:"55", which:"1",
                shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"1695", x:"55", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"6", clientY:"11", 
                ctrlKey:"false", target:"#zoomin-btn DIV", layerY:"6", 
                charCode:"0", type:"mousedown", pageX:"55", 
                cancelBubble:"false", pageY:"11", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"9", relatedTarget:null, 
                screenY:"73", time:"2000"
            },
            {
                layerX:"9", y:"11", returnValue:"true", clientX:"55", which:"1",
                shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"1695", x:"55", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"6", clientY:"11", 
                ctrlKey:"false", target:"#zoomin-btn DIV", layerY:"6", 
                charCode:"0", type:"mouseup", pageX:"55", 
                cancelBubble:"false", pageY:"11", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"9", relatedTarget:null, 
                screenY:"73", time:"1600"
            },
            {
                layerX:"9", y:"11", returnValue:"true", clientX:"55", which:"1",
                shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"1695", x:"55", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"6", clientY:"11", 
                ctrlKey:"false", target:"#zoomin-btn DIV", layerY:"6", 
                charCode:"0", type:"click", pageX:"55", 
                cancelBubble:"false", pageY:"11", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"9", relatedTarget:null, 
                screenY:"73", time:"1200"
            },
            {
                layerX:"9", y:"11", returnValue:"true", clientX:"15", which:"1",
                shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"1695", x:"15", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"6", clientY:"11", 
                ctrlKey:"false", target:"#zoomout-btn DIV", layerY:"6", 
                charCode:"0", type:"mousedown", pageX:"15", 
                cancelBubble:"false", pageY:"11", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"9", relatedTarget:null, 
                screenY:"73", time:"800"
            },
            {
                layerX:"9", y:"11", returnValue:"true", clientX:"15", which:"1",
                shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"1695", x:"15", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"6", clientY:"11", 
                ctrlKey:"false", target:"#zoomout-btn DIV", layerY:"6", 
                charCode:"0", type:"mouseup", pageX:"15", 
                cancelBubble:"false", pageY:"11", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"9", relatedTarget:null, 
                screenY:"73", time:"400"
            },
            {
                layerX:"9", y:"11", returnValue:"true", clientX:"15", which:"1",
                shiftKey:"false", cancelable:"true", bubbles:"true", 
                screenX:"1695", x:"15", button:"0", defaultPrevented:"false", 
                altKey:"false", keyCode:"0", offsetY:"6", clientY:"11", 
                ctrlKey:"false", target:"#zoomout-btn DIV", layerY:"6", 
                charCode:"0", type:"click", pageX:"15", 
                cancelBubble:"false", pageY:"11", clipboardData:null, 
                metaKey:"false", detail:"1", offsetX:"9", relatedTarget:null, 
                screenY:"73", time:"0"
             }
        ]
    } // eof test_triggerControlCalled
};         
        </script>
        
        <script type="text/javascript">

// can be copied to other testfiles, simply adjust the first variables
function test_definition(t) {
    var undef,
        xtype = 'gxm_button',        // please adjust
        className = 'GXM.Button',    // please adjust
        clazz = GXM.Button || undef, // please adjust
        minimumConf = {              // please adjust
        },
        isRegistered = false,
        cmp = null;
    
    t.plan(3);

    t.ok(GXM && 
         Ext.isDefined( clazz ) 
         && Ext.isFunction( clazz ), 'The class "' + className + '" is defined.');
    isRegistered = (clazz.xtype === xtype);

    t.ok(isRegistered, 'A xtype "' + xtype + '" is registered.');
    if (isRegistered) {
        cmp = Ext.ComponentMgr.create( minimumConf, xtype );
 
        t.ok(cmp instanceof clazz, 'The xtype "' + xtype + '" points to the class "' + className + '".');
        
        // teardown
        cmp.destroy();
    } else {
        t.ok(false, "Since the xtype is not registered, we cannot check whether it points to the right class");
    }
}

function test_triggerControlCalled(t){
    //if (Ext.is.Phone || Ext.is.Tablet) {
    if (Ext.feature.has.Touch) {	
        t.plan(1);
        t.ok(true, 'skipped because of missing event emulation for mobile device. Revisited in test "test_triggerAndHandler".');
        return;
    }
    
    var expectedBtnClicks = ['zoomIn', 'zoomOut'];
    t.plan(expectedBtnClicks.length * 2);
    
    if (!canOpenWindow()) {
        t.plan(0);
        t.debug_print("skipping this test as we aren't able to load a window.");
        return;
    }
    
    
    t.open_window('./winopen/button-test-window.html', function(wnd){
        // grab recorded events
        var recordedEvents = recordedEventData.test_triggerControlCalled;
        
        t.replay_events(wnd, recordedEvents);
        
        t.delay_call(1, function(){
            Ext.each(expectedBtnClicks, function(expectedBtn){
                t.ok(wnd.btnLogger[expectedBtn].handlerCalled, "Button '" + expectedBtn + "' was clicked and its handler-method invoked.");
                t.ok(wnd.btnLogger[expectedBtn].triggerCalled, "Button '" + expectedBtn + "' was clicked and its trigger-method invoked.");
            });
        });
    }, 5);
}

 function test_activateControlCalled(t){
	 if (Ext.feature.has.Touch) {    
        t.plan(1);
        t.ok(true, 'skipped because of missing event emulation for mobile device. Revisited in test "test_activateAndHandler".');
        return;
    }
    
    
    t.plan(3);
    
    t.open_window('./winopen/button-test-window.html', function(wnd){
    
        // grab recorded events
        var recordedEvents = recordedEventData.test_activateControlCalled;
        
        t.replay_events(wnd, recordedEvents);
        
        t.delay_call(1, function(){
        
            t.eq(wnd.btnNavStates.length, 3, "Navigation button was clicked three times.");
            
            var stateAfterFirstClick = wnd.btnNavStates[0];
            var exp_stateAfterSecondClick = (stateAfterFirstClick === 'true') ? 'false' : 'true';
            var exp_stateAfterThirdClick = stateAfterFirstClick;
            
            t.eq(wnd.btnNavStates[1], exp_stateAfterSecondClick, "State was correct toggled.");
            t.eq(wnd.btnNavStates[2], exp_stateAfterThirdClick, "State was correct toggled.");
            
        });
    }, 5);
}
 


function test_triggerAndHandler(t){
    t.plan(2);
    
    t.delay_call(1, function(){
        var triggerCnt = 0,
            handlerCnt = 0;
        
        var ctrl = new OpenLayers.Control({
            type: OpenLayers.Control.TYPE_BUTTON,
            trigger: function() {
                triggerCnt++;
            }
        });
        var btn = Ext.create('GXM.Button', {
            control: ctrl,
            map: getMapPanel(),
            handler: function() {
                handlerCnt++;
            }
        });
        
        var myToolbar = Ext.create('Ext.Toolbar', {
            docked: 'top',
            title: 'My Toolbar',
            items: [btn] 
        });
        
        var myPanel = Ext.create('Ext.Panel', {
            items: [myToolbar],
            fullscreen: true,
            html: 'Test Panel'
        });
        btn.doTap(btn, {preventDefault: function(){}});
        
        t.delay_call(1, function(){
            t.eq(triggerCnt, 1, 'The controls trigger method has been called once (triggerCnt incremented)');
            t.eq(handlerCnt, 1, 'The buttons handler method has been called once (handlerCnt incremented)');
            
            // teardown
            btn.destroy();
        });
    });
} 

 
function test_activateAndHandler(t){
    t.plan(6);
    
    var activateCnt = 0,
        deactivateCnt = 0,
        handlerCnt = 0;
        
    var ctrl = new OpenLayers.Control({
        activate: function(){
            activateCnt++;
            return OpenLayers.Control.prototype.activate.call(this, arguments);
        },
        deactivate: function(){
            deactivateCnt++;
            return OpenLayers.Control.prototype.deactivate.call(this, arguments);
        }
    });
    ctrl.activate();
    
    var btn = Ext.create('GXM.Button', {
        control: ctrl,
        map: getMapPanel(),
        handler: function() {
            handlerCnt++;
        }
    });

    var myToolbar = Ext.create('Ext.Toolbar', {
        docked: 'top',
        title: 'My Toolbar',
        items: [btn] 
    });
    
    var myPanel = Ext.create('Ext.Panel', {
        items: [myToolbar],
        fullscreen: true,
        html: 'Test Panel'
    });
    
    // reset
    activateCnt = 0;
    deactivateCnt = 0;
    handlerCnt = 0;
    
    // press the button, call internal method
    btn.doTap(btn, {preventDefault: function(){}});
    
    t.delay_call(1, function(){
        t.eq(activateCnt, 0, 'ctrl.activate() was not called.');
        t.eq(deactivateCnt, 1, 'ctrl.deactivateCnt() was called.');
        t.eq(handlerCnt, 1, 'btn.handler-meth0d was called.');
        
        // reset
        activateCnt = 0;
        deactivateCnt = 0;
        handlerCnt = 0;
        
        // press the button, call internal method
        btn.doTap(btn, {preventDefault: function(){}});
        t.delay_call(1, function(){
            t.eq(activateCnt, 1, 'ctrl.activate() was called.');
            t.eq(deactivateCnt, 0, 'ctrl.deactivateCnt() was not called.');
            t.eq(handlerCnt, 1, 'btn.handler-meth0d was called.');
            
            // teardown
            btn.destroy();
        });
    });
}

function test_handlerGetsControlStatePassed(t){
    t.plan(4);
        
    var passedArguments = {
        stdBtn: null,
        gxmBtn: null
    };
        
    var ctrl = new OpenLayers.Control({});
    ctrl.activate();
    
    var stdBtn = Ext.create('Ext.Button', {
        handler: function(){
            passedArguments.stdBtn = arguments;
        }
    });
    
    var gxmBtn = Ext.create('GXM.Button', {
        control: ctrl,
        map: getMapPanel(),
        handler: function() {
            passedArguments.gxmBtn = arguments;
        }
    });

    var myToolbar = Ext.create('Ext.Toolbar', {
        docked: 'top',
        title: 'My Toolbar',
        items: [gxmBtn, stdBtn] 
    });
    
    var myPanel = Ext.create('Ext.Panel', {
        items: [myToolbar],
        fullscreen: true,
        html: 'Test Panel'
    });
    
    // press the button, call internal method
    gxmBtn.doTap(gxmBtn, {preventDefault: function(){}});
    stdBtn.doTap(stdBtn, {preventDefault: function(){}});
    
    t.delay_call(1, function(){
        t.eq(passedArguments.gxmBtn.length, passedArguments.stdBtn.length + 1, 'GXM.Button instances pass one additional argument to the handler-method (compaired to Ext.Button).');
        t.eq(passedArguments.gxmBtn.length, 3,  'GXM.Button instances pass exactly three arguments');
        t.ok(Ext.isBoolean(passedArguments.gxmBtn[2]), 'Third argument is a boolean...');
        t.eq(passedArguments.gxmBtn[2], ctrl.active,  '... that represents the controls active-state.');
        
        // teardown
        gxmBtn.destroy();
    });
}

function test_pressedCls(t){
    t.plan(4);
    
    var ctrl = new OpenLayers.Control({});
    
    var gxmBtn = Ext.create('GXM.Button', {
        control: ctrl,
        exclusiveGroup: 'test',
        //using a pressedCls because default pressedCls is x-button-pressing, but Button get "x-button-pressed" when pressed...
        pressedCls: 'x-button-pressed',
        map: getMapPanel()
    });
    
    var segBtn = Ext.create('Ext.SegmentedButton', {
            items: [gxmBtn]
    });

    var myToolbar = Ext.create('Ext.Toolbar', {
        docked: 'top',
        title: 'My Toolbar',
        items: [gxmBtn] 
    });
    
    var myPanel = Ext.create('Ext.Panel', {
        items: [myToolbar],
        fullscreen: true,
        html: 'Test Panel'
    });
    
    // press the button, call internal method
    gxmBtn.doTap(gxmBtn, {preventDefault: function(){}});
    
    t.delay_call(1, function(){
        t.eq(gxmBtn.element.hasCls(gxmBtn.getPressedCls()), gxmBtn.getControl().active, 'states and pressedCls are in sync (triggered via btn), class present? ' + gxmBtn.element.hasCls(gxmBtn.getPressedCls()) + ', control active? ' + gxmBtn.getControl().active);
        // press the button, call internal method
        gxmBtn.doTap(gxmBtn, {preventDefault: function(){}});
        t.delay_call(1, function(){
            t.eq(gxmBtn.element.hasCls(gxmBtn.getPressedCls()), gxmBtn.getControl().active, 'states and pressedCls are in sync (triggered via btn), class present? ' + gxmBtn.element.hasCls(gxmBtn.getPressedCls()) + ', control active? ' + gxmBtn.getControl().active);
            
            // now activate the ctrl, not through the button
            ctrl.activate(); 
            t.delay_call(1, function(){
                t.eq(gxmBtn.element.hasCls(gxmBtn.getPressedCls()), gxmBtn.getControl().active, 'states and pressedCls are in sync (triggered via ctrl), class present? ' + gxmBtn.element.hasCls(gxmBtn.getPressedCls()) + ', control active? ' + gxmBtn.getControl().active);
                
                // now deactivate the ctrl, not through the button
                ctrl.deactivate(); 
                t.delay_call(1, function(){
                    t.eq(gxmBtn.element.hasCls(gxmBtn.getPressedCls()), gxmBtn.getControl().active, 'states and pressedCls are in sync (triggered via ctrl), class present? ' + gxmBtn.element.hasCls(gxmBtn.getPressedCls()) + ', control active? ' + gxmBtn.getControl().active);
                    gxmBtn.destroy();
                });
            });
        });
    });
}


function test_controlRemovalOnButtonDestroy(t){
    t.plan(4);
    
    // setup   
    var ctrl = new OpenLayers.Control({});
    var map = new OpenLayers.Map({controls:[]});
    map.addControl(ctrl);
    
    var btn = Ext.create('GXM.Button', {
        control: ctrl
    });
    
    // 1 test
    // autoadded should be false, since the control already belonged to a map
    t.eq(btn.autoadded, false, 
        'btn.autoadded property is set to false ' +
        'when the control already belonged to the map.');
    
    btn.destroy();
    
    // 1 test
    // leave the control in the map on destroy
    t.eq(map.controls.length, 1, 
        'map contains one control that was once managed by a button ' +
        'even if that button is destroyed.');
    
    
    // setup
    ctrl = new OpenLayers.Control({});
    map = new OpenLayers.Map({controls:[]});
    var mapPanel = Ext.create('GXM.Map', {
        map: map
    });
        
    btn = Ext.create('GXM.Button', {
        control: ctrl,
        map: mapPanel
    });
    
    // 1 test
    // autoadded should be true, since the control did not belong to a map
    t.eq(btn.autoadded, true, 
        'btn.autoadded property is set to true ' +
        'when the control was added to amap by GXM.Button-constructor.');
        
    btn.destroy();
    
    // 1 test
    // remve the control in the map on destroy
    t.eq(map.controls.length, 0, 
        'map does not contain a control that was once managed by a button ' +
        'because that button is destroyed and we added it to the map.');
}

        </script>
    </head>
    <body>
        
        <div id="btn"></div>
    
    </body>
</html>
