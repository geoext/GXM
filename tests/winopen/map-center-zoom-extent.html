<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

        <title>GXM: Test for the GXM.Map-class</title>

        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        
        <link rel="stylesheet" href="http://cdn.sencha.io/touch/sencha-touch-2.0.1/resources/css/sencha-touch.css" type="text/css">
        <link rel="stylesheet" href="http://openlayers.org/api/2.11/theme/default/style.css" type="text/css">
        <link rel="stylesheet" href="../../resources/css/gxm.css" type="text/css">

        <script type="text/javascript" src="http://cdn.sencha.io/touch/sencha-touch-2.0.1/sencha-touch-all.js"></script>
        <script type="text/javascript" src="http://openlayers.org/api/2.11/OpenLayers.js"></script>
        
        <!-- Setup the GXM loader -->
        <script type="text/javascript">
        Ext.Loader.setConfig({
            enabled: true,
            disableCaching: false,
            paths: {
                GXM: "../../src/GXM",
                Ext: "http://cdn.sencha.io/touch/sencha-touch-2.0.1/src"
            }
        });
        Ext.require("GXM.Map");
        </script>
        
        <!-- load test helper functions -->
        <script type="text/javascript" src="../helperfunctions.js"></script>
        
        <script type="text/javascript">
        
// globals tested in the testsuite:
var testExpectations = {
    centerAndZoom: {
        moveToCnt : 1,
        centerAsString: "lon=5,lat=45",
        zoom: 4,
        mapPanelId: null // will be set directly from the mappanel itself
    },
    zoomOnly: {
        zoom: 4
    },
    center: {
        fromOpenLayersLonLatObject: "lon=1,lat=1",
        fromString: "lon=2,lat=2",
        fromArray: "lon=3,lat=3"
    },
    extent: {
        fromOpenLayersBoundsObject: "1,2,3,4",
        fromArray: "5,6,7,8"
    },
    render: {
        renderCalled: true,
        elements: null // will be set in the test
    }
};
var testResults = {
    centerAndZoom: {
        moveToCnt : null,
        centerAsString: null,
        zoom: null,
        mapPanelId: null // will be derived from GXM.Map::guess()
    },
    zoomOnly: {
        zoom: null
    },
    center: {
        fromOpenLayersLonLatObject: null,
        fromString: null,
        fromArray: null
    },
    extent: {
        fromOpenLayersBoundsObject: null,
        fromArray: null
    },
    render: {
        renderCalled: null,
        elements: []
    }
};


        
function createStandardMapPanels() {
    var map = new OpenLayers.Map({
        controls:[],
        allOverlays: true
    });

    var moveToCnt = 0;
    map.moveTo = function(){
        moveToCnt++;
        OpenLayers.Map.prototype.moveTo.apply(this, arguments);
    };
    
    var mappanel = Ext.create('GXM.Map', {
        map: map,
        mapCenter: '5,45',
        mapZoom: 4,
        fullscreen: true,
        layers: [
            new OpenLayers.Layer()
        ]
    });
    
    // set the expected id to the one autogenerated by GXM
    window.testExpectations.centerAndZoom.mapPanelId = mappanel.id;
    
    
    // store the results in the global variable
    window.testResults.centerAndZoom.moveToCnt = moveToCnt;
    window.testResults.centerAndZoom.centerAsString = mappanel.getMap().getCenter().toString();
    window.testResults.centerAndZoom.zoom = mappanel.getMap().getZoom();
    window.testResults.centerAndZoom.mapPanelId = GXM.Map.guess().id;
    
    // cleanup
    mappanel.destroy();
    
    
    // create a mappanel with only zoom set:
    mappanel = Ext.create('GXM.Map', {
        fullscreen: true,
        mapZoom: 4,
        layers: [new OpenLayers.Layer()]
    });
    window.testResults.zoomOnly.zoom = mappanel.getMap().getZoom();
    
    // cleanup
    mappanel.destroy();

    // create three mappanels with different incarnations of mapCenter
    // ...from OpenLayers.LonLat object
    mappanel = Ext.create('GXM.Map', {
        fullscreen: true,
        mapCenter: new OpenLayers.LonLat(1,1),
        layers: [new OpenLayers.Layer()]
    });
    window.testResults.center.fromOpenLayersLonLatObject = mappanel.getMap().getCenter().toString();
    // cleanup
    mappanel.destroy();
    
    // ...from String
    mappanel = Ext.create('GXM.Map', {
        fullscreen: true,
        mapCenter: "2,2",
        layers: [new OpenLayers.Layer()]
    });
    window.testResults.center.fromString = mappanel.getMap().getCenter().toString();
    // cleanup
    mappanel.destroy();
    
    // ...from Array
    mappanel = Ext.create('GXM.Map', {
        fullscreen: true,
        mapCenter: [3,3],
        layers: [new OpenLayers.Layer()]
    });
    window.testResults.center.fromArray = mappanel.getMap().getCenter().toString();
    // cleanup
    mappanel.destroy();
    
    // create tw mappanels with different incarnations of mapExtent
    // ...from OpenLayers.Bounds object
    var logger = {};
    var map = new OpenLayers.Map({allOverlays:true});
    map.zoomToExtent = function(extent, force){
        logger.extent = extent;
    };
    
    mappanel = Ext.create('GXM.Map', {
        map: map,
        fullscreen: true,
        mapExtent: new OpenLayers.Bounds(1,2,3,4),
        layers: [new OpenLayers.Layer()]
    });
    
    window.testResults.extent.fromOpenLayersBoundsObject = logger.extent.toString();
    // cleanup
    mappanel.destroy();
    map.destroy()
    
    // ...from Array
    logger = {};
    map = new OpenLayers.Map({allOverlays:true});
    map.zoomToExtent = function(extent, force){
        logger.extent = extent;
    };
    mappanel = Ext.create('GXM.Map', {
        map: map,
        fullscreen: true,
        mapExtent:  [5,6,7,8],
        layers: [new OpenLayers.Layer()]
    });
    
    window.testResults.extent.fromArray = logger.extent.toString();
    // cleanup
    mappanel.destroy();
    map.destroy();
    
    
    // render tests
    map = getMap();
    
    var renderCalled = false;
    map.render = function() {
        renderCalled = true;
        OpenLayers.Map.prototype.render.apply(this, arguments);
    };
    var mappanel = getMapPanel({
        fullscreen: true,
        map: map,
        layers: [
            map.layers[0].clone(),
            map.layers[0].clone(),
            map.layers[0].clone()
        ]
    });
    
    //
    // when the map is rendered, we should find elements with the following 
    // classes:
    // 
    //  CSS-class        | # | element | comment     
    // ------------------+---+---------+----------------------------------
    //  .olMap           | 1 | div     | exactly one
    //  .olMapViewPort   | 1 | div     | exactly one
    //  .olLayerDiv      | 1 | div     | exactly one per layer in the map
    // 
    window.testExpectations.render.elements = [
        {
            tag: 'div',
            cssClass: 'olMap',
            expectedNum: 1
        },
        {
            tag: 'div',
            cssClass: 'olMapViewport',
            expectedNum: 1
        },
        {
            tag: 'div',
            cssClass: 'olLayerDiv',
            expectedNum: 1 * mappanel.getMap().layers.length
        }
    ];
        
    window.testResults.render.renderCalled = renderCalled;
    
    var domQueryResult,
        testResultObj;
    Ext.each(window.testExpectations.render.elements, function(expectedElem) {
        domQueryResult = Ext.DomQuery.select(expectedElem.tag + '.' + expectedElem.cssClass);
        
        if (domQueryResult.length, expectedElem.expectedNum) {
            testResultObj = {
                tag: expectedElem.tag,
                cssClass: expectedElem.cssClass,
                expectedNum: expectedElem.expectedNum,
                msg: 'We found "' + expectedElem.tag + '.' + expectedElem.cssClass + '" exactly ' + expectedElem.expectedNum + ' times.'
            };
            window.testResults.render.elements.push(testResultObj);
        }
    });
    
    mappanel.destroy();
    map.destroy();
}

Ext.setup({
    onReady: function(){
        createStandardMapPanels();
    }
})

        </script>
    </head>
    <body></body>
</html>